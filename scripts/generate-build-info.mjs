#!/usr/bin/env node
/**
 * Generate build-time version info from git.
 * Runs before build — creates identical files for frontend and server.
 *
 * NOTE: Uses execSync with hardcoded commands only (no user input).
 * This is a build script, not runtime code.
 *
 * Usage: node scripts/generate-build-info.mjs
 */

import { execSync } from 'node:child_process';
import { writeFileSync, mkdirSync } from 'node:fs';
import { dirname } from 'node:path';

function run(cmd) {
  return execSync(cmd, { encoding: 'utf-8' }).trim();
}

// Gather git info
const BUILD_HASH = run('git rev-parse --short HEAD');
const BUILD_DATE = new Date().toISOString().split('T')[0];
const BUILD_TIMESTAMP = new Date().toISOString();

// Parse last 50 commits: hash|subject|date
const rawLog = run("git log --format='%h|%s|%ai' -50");
const commits = rawLog
  .split('\n')
  .filter(Boolean)
  .map((line) => {
    // Strip surrounding quotes if present
    const clean = line.replace(/^'|'$/g, '');
    const [hash, ...rest] = clean.split('|');
    const datePart = rest.pop();
    const message = rest.join('|');

    // Extract conventional commit type
    const typeMatch = message.match(/^(\w+)(?:\(.*?\))?:\s*/);
    const type = typeMatch ? typeMatch[1] : 'other';

    return { hash, message, date: datePart, type };
  });

// Generate TypeScript source
const tsContent = `// AUTO-GENERATED by scripts/generate-build-info.mjs — do not edit
export const BUILD_HASH = '${BUILD_HASH}';
export const BUILD_DATE = '${BUILD_DATE}';
export const BUILD_TIMESTAMP = '${BUILD_TIMESTAMP}';

export interface CommitEntry {
  readonly hash: string;
  readonly message: string;
  readonly date: string;
  readonly type: string;
}

export const COMMIT_LOG: readonly CommitEntry[] = ${JSON.stringify(commits, null, 2)};
`;

// Write to both frontend and server
const targets = [
  'ui/src/lib/generated/build-info.ts',
  'src/generated/build-info.ts',
];

for (const target of targets) {
  mkdirSync(dirname(target), { recursive: true });
  writeFileSync(target, tsContent, 'utf-8');
  console.log(`  wrote ${target}`);
}

console.log(`Build info: ${BUILD_HASH} @ ${BUILD_TIMESTAMP} (${commits.length} commits)`);
